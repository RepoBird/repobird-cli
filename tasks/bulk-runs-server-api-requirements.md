# Bulk Runs Server API Requirements

## Overview
This document specifies the server-side API requirements for supporting bulk/batch run creation in RepoBird. The goal is to enable parallel execution of multiple runs with a single API request, optimizing for efficiency and user experience.

## API Endpoint Specifications

### 1. Create Bulk Runs Endpoint

#### Endpoint
```
POST /api/v1/runs/bulk
```

#### Request Structure

##### Option A: Single Repository, Multiple Prompts
```json
{
  "repositoryName": "org/repo",  // OR "repoId": 123 (REQUIRED)
  "batchTitle": "Authentication module refactoring",  // Optional
  "runType": "run",              // Optional, defaults to "run"
  "sourceBranch": "main",         // Optional, defaults to repo default branch
  "targetBranch": "feature/bulk", // Optional, auto-generated if not provided
  "force": false,                 // Optional, override duplicate detection for all runs
  "runs": [
    {
      "prompt": "Fix authentication bug",  // REQUIRED
      "title": "Fix auth issue",           // Optional, generated from prompt if not provided
      "context": "Users can't login",      // Optional
      "target": "fix/auth-bug-1",          // Optional, auto-generated if not provided
      "fileHash": "hash1"                  // Optional, for duplicate detection
    },
    {
      "prompt": "Add password reset",      // REQUIRED
      "title": "Password reset feature",   // Optional
      "context": "Implement forgot password", // Optional
      "fileHash": "hash2"                  // Optional
    }
  ]
}
```

##### Option B: Minimal Request (Only Required Fields)
```json
{
  "repositoryName": "org/repo",  // REQUIRED
  "runs": [
    {
      "prompt": "Fix the login bug"  // Only prompt is required
    },
    {
      "prompt": "Add password reset functionality"
    },
    {
      "prompt": "Update user profile page"
    }
  ]
}
```

##### Option C: With Batch Title and Force Override (CLI Generated)
```json
{
  "repoId": 123,  // Using repoId instead of repositoryName
  "batchTitle": "Q1 2024 Bug Fixes",  // Optional batch title for grouping
  "force": true,  // Override duplicate detection (useful when re-running from file)
  "runs": [
    {
      "prompt": "Fix bug #123",
      "title": "Critical auth fix",  // Optional title
      "fileHash": "abc123"  // Generated by CLI from config file content
    },
    {
      "prompt": "Fix bug #124",
      "context": "Users report timeout issues",  // Optional context
      "fileHash": "def456"  // Generated by CLI
    },
    {
      "prompt": "Fix bug #125",
      "target": "hotfix/bug-125",  // Optional explicit target branch
      "fileHash": "ghi789"  // Generated by CLI
    }
  ]
}

// Note: fileHash values are generated by the CLI/TUI tool when loading config files,
// not specified by users in their config files
```

#### Response Structure

##### Success Response (200 OK) - All Runs Created
```json
{
  "data": {
    "batchId": "batch_20240120_abc123",  // Always generated unique ID
    "batchTitle": "Authentication module refactoring",  // If provided in request
    "successful": [
      {
        "id": 12345,
        "status": "QUEUED",
        "repositoryName": "org/repo",
        "title": "Fix auth issue",
        "requestIndex": 0  // Position in original request
      },
      {
        "id": 12346,
        "status": "QUEUED",
        "repositoryName": "org/repo",
        "title": "Password reset feature",
        "requestIndex": 1
      }
    ],
    "failed": [],  // Empty when all successful
    "metadata": {
      "totalRequested": 2,
      "totalSuccessful": 2,
      "totalFailed": 0
    }
  }
}
```

##### Partial Success Response (207 Multi-Status)
```json
{
  "data": {
    "batchId": "batch_20240120_xyz789",  // Always generated, even with failures
    "batchTitle": null,  // If not provided
    "successful": [
      {
        "id": 12345,
        "status": "QUEUED",
        "title": "Fix auth issue",
        "requestIndex": 0
      }
    ],
    "failed": [
      {
        "requestIndex": 1,
        "prompt": "Add password reset",  // Original prompt for reference
        "error": "DUPLICATE_RUN",
        "message": "Duplicate detected (ID: 12300). Use force:true to override.",
        "existingRunId": 12300
      },
      {
        "requestIndex": 2,
        "prompt": "Update user profile",
        "error": "QUOTA_EXCEEDED",
        "message": "No remaining pro runs. Current quota: 0"
      }
    ],
    "metadata": {
      "totalRequested": 3,
      "totalSuccessful": 1,
      "totalFailed": 2
    }
  }
}
```

##### Error Response (400 Bad Request) - Validation Failed
```json
{
  "error": "INVALID_BULK_REQUEST",
  "message": "Bulk request validation failed",
  "batchId": null,  // No batch created on validation failure
  "details": [
    {
      "field": "repositoryName",
      "error": "Either repositoryName or repoId is required"
    },
    {
      "field": "runs",
      "error": "Batch size exceeds maximum of 10 runs (got 15)"
    },
    {
      "field": "runs[0].prompt",
      "error": "Prompt is required for each run"
    }
  ]
}
```

##### Complete Failure Response (403 Forbidden)
```json
{
  "data": {
    "batchId": "batch_20240120_failed",  // Still generated for tracking
    "batchTitle": "Failed batch",
    "successful": [],
    "failed": [
      {
        "requestIndex": 0,
        "prompt": "Fix auth bug",
        "error": "REPOSITORY_DISABLED",
        "message": "Repository org/repo is disabled"
      },
      {
        "requestIndex": 1,
        "prompt": "Add feature",
        "error": "REPOSITORY_DISABLED",
        "message": "Repository org/repo is disabled"
      }
    ],
    "metadata": {
      "totalRequested": 2,
      "totalSuccessful": 0,
      "totalFailed": 2
    }
  }
}
```

### 2. Get Bulk Run Status Endpoint

#### Endpoint
```
GET /api/v1/runs/bulk/{batchId}
```

Note: This endpoint aggregates data from individual runs with the same `batch_id` in the `issue_runs` table.

#### Response
```json
{
  "data": {
    "batchId": "batch_abc123",
    "batchTitle": "Refactoring authentication module",
    "status": "PROCESSING",  // Calculated from individual run statuses
    "runs": [
      {
        "id": 12345,
        "status": "DONE",
        "title": "Fix auth issue",
        "completedAt": "2024-01-20T10:30:00Z",
        "prUrl": "https://github.com/org/repo/pull/123"
      },
      {
        "id": 12346,
        "status": "PROCESSING",
        "title": "Password reset feature",
        "progress": 45
      }
    ],
    "metadata": {
      "totalRuns": 2,
      "completed": 1,
      "processing": 1,
      "failed": 0,
      "startedAt": "2024-01-20T10:00:00Z",
      "estimatedCompletionTime": "2024-01-20T10:45:00Z"
    }
  }
}
```

The server queries all runs with the given `batch_id` and aggregates their statuses.

### 3. Cancel Bulk Runs Endpoint

#### Endpoint
```
DELETE /api/v1/runs/bulk/{batchId}
```

#### Response
```json
{
  "data": {
    "batchId": "batch_abc123",
    "cancelled": [12346, 12347],
    "completed": [12345],
    "message": "Cancelled 2 of 3 runs (1 already completed)"
  }
}
```

## File Hash Duplicate Detection for Bulk Runs

### Duplicate Detection Logic

1. **Per-Run Hash Check**: Each run in the batch should have its own fileHash
2. **Batch-Level Hash**: Optional batch-level hash for the entire configuration
3. **Force Override**: Support both batch-level and per-run force flags

```json
{
  "batchFileHash": "hash_of_entire_config",  // Optional
  "force": false,  // Batch-level override
  "runs": [
    {
      "prompt": "Fix bug",
      "fileHash": "individual_hash1",
      "force": false  // Per-run override (overrides batch-level)
    }
  ]
}
```

### Duplicate Handling

The `force` field at the top level controls duplicate detection:
- `force: false` (default): Check for duplicates and report them in failed array
- `force: true`: Override all duplicate detection, create runs even if fileHash exists

Individual runs can include `fileHash` for tracking which file they came from.

## Rate Limiting & Quotas

### Quota Validation and Consumption

1. **Pre-validation**: Before creating any runs, validate that user has enough remaining runs
   - Check `remainingProRuns` or `remainingPlanRuns` based on `runType`
   - If requested runs > remaining quota, return error immediately
   - Example: User requests 5 runs but only has 3 remaining → error

2. **Quota Consumption**: 
   - Each run in the batch consumes from the appropriate quota
   - `runType: "run"` → consumes from `remainingProRuns`
   - `runType: "plan"` → consumes from `remainingPlanRuns`
   
3. **Partial Success with Force**:
   - If `force: true` and not enough quota for all runs
   - Create as many runs as quota allows (in order)
   - Return successful runs and failed runs with `QUOTA_EXCEEDED` error
   - Example: 5 runs requested, 3 remaining → create first 3, fail last 2

### Example Quota Response
```json
{
  "data": {
    "batchId": "batch_20240120_partial",
    "successful": [
      {"id": 1, "title": "Run 1", "requestIndex": 0},
      {"id": 2, "title": "Run 2", "requestIndex": 1},
      {"id": 3, "title": "Run 3", "requestIndex": 2}
    ],
    "failed": [
      {
        "requestIndex": 3,
        "prompt": "Run 4", 
        "error": "QUOTA_EXCEEDED",
        "message": "Insufficient pro runs remaining. Need 2, have 0"
      },
      {
        "requestIndex": 4,
        "prompt": "Run 5",
        "error": "QUOTA_EXCEEDED", 
        "message": "Insufficient pro runs remaining. Need 1, have 0"
      }
    ],
    "metadata": {
      "quotaConsumed": 3,
      "quotaRemaining": 0,
      "totalRequested": 5,
      "totalSuccessful": 3,
      "totalFailed": 2
    }
  }
}
```


## Validation Rules

### Request Validation

1. **Repository Requirements**:
   - Either `repositoryName` OR `repoId` required
   - Repository must exist and be enabled
   - User must have access

2. **Batch Size Validation** (Server-side):
   - Maximum: 10 runs per batch (hardcoded limit)
   - If `len(runs) > 10` → return 400 Bad Request
   - Error: "Batch size exceeds maximum of 10 runs"

3. **Quota Validation**:
   - Check user has sufficient `remainingProRuns` or `remainingPlanRuns`
   - If insufficient quota and `force: false` → reject entire batch
   - If insufficient quota and `force: true` → create as many as quota allows

4. **Run Limits**:
   - Minimum: 1 run (though typically 2+ for bulk)
   - Maximum: 10 runs per batch (enforced server-side)
   - Total prompt length: 50,000 characters

4. **Branch Validation**:
   - Source branches must exist
   - Target branches auto-generated if not provided
   - Format: `bulk/{batchId}/{index}-{sanitized-title}`

### Response Codes

- `200 OK`: All runs created successfully
- `207 Multi-Status`: Partial success
- `400 Bad Request`: Validation failed
- `403 Forbidden`: Quota exceeded or repo disabled
- `429 Too Many Requests`: Rate limited

## Database Considerations

### Batch Tracking in Issue Runs
The existing issue runs table needs to be extended with batch-related fields:

- **batch_id**: Unique identifier for the batch (e.g., `batch_20240120_abc123`)
- **batch_title**: Optional human-readable title for the entire batch

### Batch ID Generation Strategy
- Format: `batch_{timestamp}_{random}` for uniqueness
- All runs in a batch share the same `batch_id`

### Querying Batch Data
The server needs to efficiently:
- Retrieve all runs belonging to a specific batch
- Calculate aggregate statistics (completed, failed, processing counts)
- Filter by user and batch ID for security

## Error Handling

### Batch-Level Errors
- `BATCH_TOO_LARGE`: Exceeds max batch size
- `QUOTA_EXCEEDED`: Not enough runs remaining
- `INVALID_BATCH_CONFIG`: Configuration validation failed

### Run-Level Errors
- `DUPLICATE_RUN`: File hash already exists
- `REPOSITORY_NOT_FOUND`: Repository doesn't exist
- `BRANCH_NOT_FOUND`: Source branch doesn't exist
- `REPOSITORY_DISABLED`: Repository is disabled

## Migration & Backwards Compatibility

1. **Existing Single Run Endpoint**: Keep unchanged
2. **Bulk Endpoint**: New addition, no breaking changes
3. **Client Detection**: Use API version header
4. **Graceful Degradation**: Bulk requests can fallback to sequential single requests

## Security Considerations

1. **Authorization**:
   - Verify user has access to all repositories in batch
   - Rate limit by user, not just IP
   - Audit log for bulk operations

2. **Resource Protection**:
   - CPU/memory limits per batch
   - Timeout for long-running batches
   - Circuit breaker for failing repositories

## Monitoring & Analytics

### Metrics to Track
- Batch size distribution
- Success/failure rates per batch
- Average completion time
- Queue depth and wait times
- Resource usage per batch

### Logging
```json
{
  "event": "BULK_RUN_CREATED",
  "batchId": "batch_abc123",
  "userId": 456,
  "runCount": 5,
  "repositories": ["org/repo1", "org/repo2"],
  "timestamp": "2024-01-20T10:00:00Z"
}
```

## Implementation Priority

### Phase 1 (MVP)
- Basic bulk creation endpoint
- Single repository, multiple prompts
- Simple duplicate detection
- Synchronous processing

### Phase 2
- Advanced duplicate strategies
- Batch status endpoint optimizations
- Progress tracking improvements

### Phase 3
- Batch templates
- Scheduled batch runs
- Dependency management between runs
- Advanced quota management
